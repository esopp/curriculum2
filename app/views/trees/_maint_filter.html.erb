<%= form_for @tree, url: maint_trees_path, :html => { :method => 'GET' } do |form| %>
  <% param_name = (col == "tree" ? col : "dim_tree" ) %>
  <!-- Workaround for inconsistently named essq/ess_q
       dim_key is the column type, whereas @dim_type is
       the page, if on a dimensions page.
  -->
  <% dim_key = col.split("_").join("") %>

  <div class='row'>
    <!-- Hidden fields -->
    <!-- Pass setting to stay in edit mode after submitting form, if currently in edit mode -->
    <% if @editing %>
      <input type='hidden' name='editme' value=true></input>
    <% end %>
    <!-- If @dim_type is defined, we are rendering one of the dimension-specific pages (e.g., the Misconceptions page) -->
    <% if @dim_type %>
      <input type='hidden' name='dim_tree[dim_type]' value="<%= @dim_type%>"></input>
    <% end %>

    <!--
      TO DO: REPLACE LOGIC
      If searching for a different set of one dim type, don't forget the current settings for other dimension types. -->




    <!-- Labels -->
    <div class='col col-lg-1 col-md-<%= @editing ? 3 : 2 %>'><label for='<%= param_name %>_subject'><%= translate('app.labels.subject') %></label></div>
    <div class='col col-lg-<%= @editing ? 5 : 1 %> col-md-<%= @editing ? 5 : 2 %>'><label for='<%= param_name %>_grade_band'><%= translate('app.labels.grade_band') %></label></div>
  </div>

  <!-- Form input options -->
  <div class='row'>
    <div class='col col-lg-1 col-md-2 subject-with-gb'><select id='<%= param_name %>_subject_id' name='<%= param_name %>[<%= param_name == "tree" ? "subject_id" : "#{col}_subj_code"%>]'>
        <% if col == "tree" %>
          <% @subjects.each do |k, s| %>
            <% sel_code = @subject_code %>
            <%- selectedStr = (s.code == sel_code) ? ' selected = "selected"' : '' %>
            <%= Rails.logger.debug(" +++ index match output: #{selectedStr}") %>
            <option value=<%= s.id %><%= selectedStr %>><%= @translations[Subject.get_default_abbr_key(s.code)] %></option>
          <% end %>
        <% else # if col != "tree" %>
          <% BaseRec::BASE_SUBJECTS.each do |s| %>
            <% sel_code = @dim_filters[dim_key][:subj]
               opt_name = @translations[Subject.get_default_abbr_key(s)]
            %>
            <%- selectedStr = (s == sel_code) ? ' selected = "selected"' : '' %>
            <option value=<%= s %><%= selectedStr %>><%= opt_name %></option>
          <% end %>
        <% end # if col == "tree" %>
    </select></div>
    <div id='<%= param_name %>-gb-container' class='col col-lg-<%= @editing ? 5 : 1 %> col-md-<%= @editing ? 5 : 2 %>'>
      <span id='<%= param_name %>-all-gbs-select'>
      <!-- %= collection_select(:tree, :grade_band_id, @gbs, :id, :code, include_blank: I18n.t('app.labels.all') ) % -->
      <select id='<%= param_name %>_grade_band_id' name='<%= param_name %>[<%= param_name == "tree" ? "grade_band_id" : "#{col}_gb_id" %>]'>
        <option value='0'><%= I18n.t('app.labels.all') %></option>
      <% @gbs.each do |gb| %>
        <% gbc = @grade_band_code
           gbc = @dim_filters[col][:gb][:code] if col != "tree" && @dim_filters[col][:gb][:code]
        %>
        <%- selectedStr = (gb.code == gbc) ? ' selected = "selected"' : '' %>
        <%= Rails.logger.debug("gb index match: #{gb.code} == #{@grade_band_code} output: #{selectedStr}") %>
        <option value=<%= gb.id%><%= selectedStr %>><%=gb.code%></option>
      <% end %>
    </select>
      </span>
    </div>

    <div class='col col-lg-1 col-md-3 margin-bottom'><%= form.submit translate('app.labels.gen_list'), :class => 'btn-primary' %></div>
  </div>
<% end #form %>
<% if col == "tree" %>
  <div>
    <button class="btn btn-link btn-sm pull-left right-margin" onclick="show_hide_selection('.collapsable', true)"><%= I18n.translate("app.labels.expand_all") %></button>
    <button class="btn btn-link btn-sm pull-left" onclick="show_hide_selection('.collapsable', false)"><%= I18n.translate("app.labels.collapse_all") %></button>
    <%
    @hierarchiesInTrees.each_with_index do |h, ix|
      if ix > 0 && ix <= @treeTypeRec.outcome_depth
      hierarchy_depth = @hierarchies.index(@hierarchiesInTrees[ix])
    %>
        <button class='btn btn-info btn-sm pull-left right-margin' onclick="show_hierarchy_level('<%= hierarchy_depth %>', '<%= @treeTypeRec[:outcome_depth] %>')"><%= I18n.t('app.labels.show') %> <%= @hierarchiesInTrees[ix].pluralize if @hierarchiesInTrees.length > ix %></button>
    <%
      end
    end
    %>
    <% if !@editing %>
      <button id="show-details-btn" class="btn btn-link btn-sm pull-left right-margin" onclick="show_maint_details()">
        <span id="show-text" class="hidden">Show Details</span>
        <span id="hide-text">Hide Details</span>
      </button>
    <% end %>
  </div>
<% end %>