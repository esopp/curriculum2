<% content_for(:title_code, 'trees.show.name') %>
<% content_for(:page_class, 'trees') %>

<%
  # to do - refactor this somehow?
  outcome = @tree
  component = outcome.present? ? outcome.getParentRec : nil
  area = component.present? ? component.getParentRec : nil
%>
<div class='container'>
  <!--  loop through all tree items to display (to display multimle LOs when asked to display detail for higher Level tree item) -->
  <% @tree_items_to_display.each do |tree| %>
    <div class='detail-page'>
      <% tree_parents = tree.getAllParents %>

      <!-- Display the translated descriptions of all parents for this item (Grade, Unit, Chapter, Outcome)  -->
      <% @hierarchies.each_with_index do |e, i|
         if i <= @treeTypeRec[:outcome_depth]
           rec = (i == @treeTypeRec[:outcome_depth] ? tree : tree_parents[tree_parents.length - 1 - i])
           label_text = @translations[rec.buildNameKey]
       %>
         <div class='row subject-<%= e.downcase %>-row'><div class='col col-lg-6 text-left'><%= "#{"#{@subjectByCode[tree.subject.code][:name]} " if i == 0}#{e}#{" " + rec.codeArrayAt(i) if i > 0}" %>: <%= label_text %>
           <% if i == @treeTypeRec[:outcome_depth] %>
             <%= link_to(fa_icon("edit"), edit_tree_path(@tree.id, tree: { edit_type: 'outcome'}), {:remote => true, 'data-toggle' =>  "modal", 'data-target' => '#modal_popup'}) if @editMe %>
           <% end %>
         </div></div>
      <% end
      end %>

      <div class='col col-lg-12 text-right'>
          <% if @editMe %>
            <span class='font-weight-bold'>Editing</span>
          <% else %>
            <%= link_to("Edit #{@hierarchies[@treeTypeRec[:outcome_depth]]}", tree_path(@tree.id, editme: @tree.id) ) if current_user.present? %>
            <!-- # %= link_to("Edit LO", edit_tree_path(@tree.id), {:remote => true, 'data-toggle' =>  "modal", 'data-target' => '#modal_popup'}) % -->
          <% end %>
        </div>

      <!-- Related Indicators Table -->
      <% if @hierarchies.count > @treeTypeRec[:outcome_depth] + 1 %>
      <div class='related-indicators'>
        <div class='row center-label-bold top-label'>
          <div class='col col-lg-12'>
            <%= @indicator_name %>
          </div>
        </div>
        <% tree.getAllChildren.each do |c| %>
        <div class='row'>
          <div class='col col-lg-2 ind-col'>
            <%= c.code %>
          </div>
          <div class='col col-lg-10 ind-col last-col'>
            <%= @translations[c.buildNameKey] %>
            <%= link_to(fa_icon("edit"), edit_tree_path(@tree.id, tree: { edit_type: 'indicator', attr_id: c.id}), {:remote => true, 'data-toggle' =>  "modal", 'data-target' => '#modal_popup'}) if @editMe %>
          </div>
        </div>
        <% end %>
        <%
          ind_codes = JSON.load(tree.matching_codes)
          ind_codes.each do |ia|
            code = "#{tree.buildRootKey}.#{ia}.name"
        %>
          <p><%= "#{I18n.translate('app.labels.indicator')} #{ia}: #{@translations[code]}" %></p>
        <% end %>
      </div>
      <% end %>

      <!-- Related Big Ideas Table -->
      <% if  @treeTypeRec.big_ideas_dim_type %>
        <div class='related-items-table'>
          <div class='row center-label-bold top-label'>
            <div class='col col-lg-12'>
              <%= @bigIdeasTitle %>
            </div>
          </div>
        <div class='row'>
          <div class='col col-lg-6 rel-sector-col center-label'>
            <%= @bigIdeasTitle %>
          </div>
          <div class='col col-lg-6 rel-reason-col center-label'>
            <%= I18n.t('app.labels.explanation') %>
          </div>
        </div>
          <% tree.dim_trees.each do |dt|
            d = dt.dimension
            if d.dim_type == @treeTypeRec.big_ideas_dim_type
          %>
            <div class='row'>
              <div class='col col-lg-6 rel-sectors'>
                <%= @translations[d.dim_name_key] %>
              </div>
              <div class='col col-lg-6 ind-col last-col'>
                <%= @translations[dt.dim_explanation_key] %>
                <% if @editMe %>
                  <%= link_to(fa_icon("times"), tree_path(@tree.id, tree: { edit_type: 'dimtree', attr_id: dt[:id], active: false}, sector_tree: {active: false}), {:class => "fa-lg pull-right", method: :patch}) if @editMe %>
                  <%= link_to(fa_icon("edit"), edit_tree_path(@tree.id, tree: { edit_type: 'dimtree', attr_id: dt[:id]}), {:remote => true, :class => "fa-lg pull-right", 'data-toggle' =>  "modal", 'data-target' => '#modal_popup'}) if @editMe %>
                <% end %>
              </div>
            </div>
          <%
            end
          end
          %>
        </div>
      <% end %>

      <!-- Related Misconceptions Table -->
      <% if @treeTypeRec.miscon_dim_type %>
        <div class='related-items-table'>
          <div class='row center-label-bold top-label'>
            <div class='col col-lg-12'>
              <%= I18n.t('trees.miscon.title') %>
            </div>
          </div>
          <div class='row'>
            <div class='col col-lg-6 rel-sector-col center-label'>
              <%= I18n.t('trees.miscon.title') %>
            </div>
            <div class='col col-lg-6 rel-reason-col center-label'>
              <%= I18n.t('app.labels.explanation') %>
            </div>
          </div>
          <% tree.dim_trees.each do |dt|
            d = dt.dimension
            if d.dim_type ==  @treeTypeRec.miscon_dim_type
          %>
            <div class='row'>
              <div class='col col-lg-6 rel-sectors'>
                <%= @translations[d.dim_name_key] %>
              </div>
              <div class='col col-lg-6 ind-col last-col'>
                <%= @translations[dt.dim_explanation_key] %>
                <% if @editMe %>
                  <%= link_to(fa_icon("times"), tree_path(@tree.id, tree: { edit_type: 'dimtree', attr_id: dt[:id], active: false}, sector_tree: {active: false}), {:class => "fa-lg pull-right", method: :patch}) if @editMe %>
                  <%= link_to(fa_icon("edit"), edit_tree_path(@tree.id, tree: { edit_type: 'dimtree', attr_id: dt[:id]}), {:remote => true, :class => "fa-lg pull-right", 'data-toggle' =>  "modal", 'data-target' => '#modal_popup'}) if @editMe %>
                <% end %>
              </div>
            </div>
          <%
            end
          end
          %>
        </div>
      <% end %>

      <!-- Future Sectors Table -->
      <div class='related-items-table'>
        <div class='row center-label-bold top-label'>
          <div class='col col-lg-12'>
            <%= I18n.t('nav_bar.sectors.name') %>
              <% if @editMe && false %>
                <a href="#"><span class="pull-right">
                  <i class="fa fa-plus-square fa-lg"></i>
                </span></a>
              <% end %>
          </div>
        </div>
        <div class='row'>
          <div class='col col-lg-6 rel-sector-col center-label'>
            <%= I18n.t('trees.labels.related_sectors') %>
          </div>
          <div class='col col-lg-6 rel-reason-col center-label'>
            <%= I18n.t('trees.labels.how_sectors_related') %>
          </div>
        </div>
        <% tree.sector_trees.active.each do |st| %>
          <div class='row'>
            <div class='col col-lg-6 rel-sectors'>
              <%= link_to(
                "#{@translations[st.sector.name_key]}",
                sectors_path(
                  controller: 'sector',
                  action: 'index',
                  tree: {
                    sector_id: "#{st.sector.id}",
                    grade_band_id: "#{@tree.grade_band_id}",
                    subject_id: "#{@tree.subject_id}"
                  }
                ),
                html_options = {data: { :sector => st.sector.id }}
              ) %>
            </div>
            <div class='col col-lg-6 rel-reason-col val'>
              <%= @translations["#{st.explanation_key}"] %>
              <% if @editMe %>
                <%= link_to(fa_icon("times"), tree_path(@tree.id, tree: { edit_type: 'sector', attr_id: st[:id], active: false}, sector_tree: {active: false}), {:class => "fa-lg pull-right", method: :patch}) if @editMe %>
                <%= link_to(fa_icon("edit"), edit_tree_path(@tree.id, tree: { edit_type: 'sector', attr_id: st[:id]}), {:remote => true, :class => "fa-lg pull-right", 'data-toggle' =>  "modal", 'data-target' => '#modal_popup'}) if @editMe %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Connections to Other Outcomes Table -->
      <div class='related-items-table'>
        <div class='row subject-relations center-label-bold top-label'>
          <div class='col col-lg-12'>
            <%= I18n.t('trees.labels.outcome_connections', outcome: (@hierarchies[3].pluralize if @hierarchies.length > 3)) %>
              <% if @editMe && false %>
                <a href="#"><span class="pull-right">
                  <i class="fa fa-plus-square fa-lg"></i>
                </span></a>
              <% end %>
          </div>
        </div>
        <div class='connections-grid'>
          <div class='connections-header'>
            <div class='center-label sub-header-margin'>
              <%= I18n.t('trees.labels.relation') %>
            </div>
          </div>
          <div class='connections-header'>
            <div class='center-label sub-header-margin'>
              <%= I18n.t('app.labels.subject') %>
            </div>
          </div>
          <div class='connections-header'>
            <div class='center-label sub-header-margin'>
              <%= I18n.t('app.labels.code') %>
            </div>
          </div>
          <div class='connections-header'>
            <div class='center-label sub-header-margin'>
              <%= I18n.t('app.labels.description') %>
            </div>
          </div>
          <div class='connections-header'>
            <div class='center-label sub-header-margin'>
              <%= I18n.t('trees.labels.how_outcome_related') %>
            </div>
          </div>

        </div>
        <div class='connections-grid'>
          <% @relatedBySubj.each do |subj, rel|%>
            <% rel.each do |r| %>
              <div class='connections-item'>
                <%= r[:relationship] %>
              </div>
              <div class='connections-item'>
                <%= I18n.t("trees.labels.#{subj}") %>
              </div>
              <div class='connections-item'>
                <%= r[:code] %>
              </div>
              <div class='connections-item'>
                <% if r[:tid] == 0 %>
                  <%= @translations[r[:tkey]] %>
                <% else %>
                  <a href='/<%= @locale_code %>/trees/<%= r[:tid] %>'><%= @translations[r[:tkey]] %></a>
                <% end %>
              </div>
              <div class='connections-item'>
                <%= @translations[r[:explanation]] %>
                <% if @editMe %>
                  <%= link_to(fa_icon("times"), tree_path(@tree.id, tree: { edit_type: 'treetree', attr_id: r[:ttid], active: false}, tree_tree: {active: false}), {:class => "fa-lg pull-right", method: :patch}) if @editMe %>
                  <%= link_to(fa_icon("edit"), edit_tree_path(@tree.id, tree: { edit_type: 'treetree', attr_id: r[:ttid]}), {:remote => true, :class => "fa-lg pull-right", 'data-toggle' =>  "modal", 'data-target' => '#modal_popup'}) if @editMe %>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Supporting Resources Table -->
      <div class='row teacher-label top-label'>
        <div class='col col-lg-12'>
          <%= I18n.t('trees.labels.teacher_header') %>
        </div>
      </div>
      <div class='teacher-grid'>
        <div class='teacher-item'>
          <div class='center-label sub-header-margin'>
            <%= I18n.t('trees.labels.teacher_field_1') %>
          </div>
        </div>
        <div class='teacher-item'>
          <div class='center-label sub-header-margin'>
            <%= I18n.t('trees.labels.teacher_field_2') %>
          </div>
        </div>
        <div class='teacher-item'>
          <div class='center-label sub-header-margin'>
            <%= I18n.t('trees.labels.teacher_field_3') %>
          </div>
        </div>
        <div class='teacher-item'>
          <div class='center-label sub-header-margin'>
            <%= I18n.t('trees.labels.teacher_field_4') %>
          </div>
        </div>
        <div class='teacher-item'>
          <div class='center-label sub-header-margin'>
            <%= I18n.t('trees.labels.teacher_field_5') %>
          </div>
        </div>
        <div class='teacher-item'>
          <div class='center-label sub-header-margin'>
            <%= I18n.t('trees.labels.teacher_field_6') %>
          </div>
        </div>
      </div>
      <div class='row outcome-row'>
        <div class='col col-lg-6 text-right'>
          <% if @editMe %>
            <span class='font-weight-bold'>Editing</span>
          <% else %>
            <!-- %= # link_to("Edit LO", tree_path(@tree.id, editme: @tree.id) ) % -->
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
